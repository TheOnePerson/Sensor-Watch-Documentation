<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.9.2"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Sensor Watch: Deep Sleep Control</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Sensor Watch<span id="projectnumber">&#160;0.0.0</span>
   </div>
   <div id="projectbrief">A board replacement for the classic Casio F-91W wristwatch, powered by a Microchip SAM L22 microcontroller.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.9.2 -->
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
var searchBox = new SearchBox("searchBox", "search",'Search','.html');
/* @license-end */
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
/* @license magnet:?xt=urn:btih:d3d9a9a6595521f9666a5e94cc830dab83b65699&amp;dn=expat.txt MIT */
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
/* @license-end */
</script>
<div id="main-nav"></div>
</div><!-- top -->
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="summary">
<a href="#func-members">Functions</a>  </div>
  <div class="headertitle"><div class="title">Deep Sleep Control</div></div>
</div><!--header-->
<div class="contents">

<p>This section covers functions related to preparing for and entering BACKUP mode, the deepest sleep mode available on the SAM L22.  
<a href="#details">More...</a></p>
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 class="groupheader"><a id="func-members" name="func-members"></a>
Functions</h2></td></tr>
<tr class="memitem:gacad726423f5f38697c87474ab25244ca"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__deepsleep.html#gacad726423f5f38697c87474ab25244ca">watch_register_extwake_callback</a> (uint8_t pin, ext_irq_cb_t callback, bool level)</td></tr>
<tr class="memdesc:gacad726423f5f38697c87474ab25244ca"><td class="mdescLeft">&#160;</td><td class="mdescRight">Registers a callback on one of the RTC's external wake pins, which can wake the device from deep sleep (aka BACKUP) mode.  <a href="group__deepsleep.html#gacad726423f5f38697c87474ab25244ca">More...</a><br /></td></tr>
<tr class="separator:gacad726423f5f38697c87474ab25244ca"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaae4dfbad44338b179a7b2d8a286bacbe"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__deepsleep.html#gaae4dfbad44338b179a7b2d8a286bacbe">watch_disable_extwake_interrupt</a> (uint8_t pin)</td></tr>
<tr class="memdesc:gaae4dfbad44338b179a7b2d8a286bacbe"><td class="mdescLeft">&#160;</td><td class="mdescRight">Unregisters the RTC interrupt on one of the EXTWAKE pins. This will prevent a value change on one of these pins from waking the device from shallow and deep sleep modes.  <a href="group__deepsleep.html#gaae4dfbad44338b179a7b2d8a286bacbe">More...</a><br /></td></tr>
<tr class="separator:gaae4dfbad44338b179a7b2d8a286bacbe"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga385b36922ec76c5fe697772f97a05846"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__deepsleep.html#ga385b36922ec76c5fe697772f97a05846">watch_store_backup_data</a> (uint32_t data, uint8_t reg)</td></tr>
<tr class="memdesc:ga385b36922ec76c5fe697772f97a05846"><td class="mdescLeft">&#160;</td><td class="mdescRight">Stores data in one of the RTC's backup registers, which retain their data in deep sleep mode.  <a href="group__deepsleep.html#ga385b36922ec76c5fe697772f97a05846">More...</a><br /></td></tr>
<tr class="separator:ga385b36922ec76c5fe697772f97a05846"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:ga2de1f1012475654c4741f60808581196"><td class="memItemLeft" align="right" valign="top">uint32_t&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__deepsleep.html#ga2de1f1012475654c4741f60808581196">watch_get_backup_data</a> (uint8_t reg)</td></tr>
<tr class="memdesc:ga2de1f1012475654c4741f60808581196"><td class="mdescLeft">&#160;</td><td class="mdescRight">Gets 32 bits of data from the RTC's backup register.  <a href="group__deepsleep.html#ga2de1f1012475654c4741f60808581196">More...</a><br /></td></tr>
<tr class="separator:ga2de1f1012475654c4741f60808581196"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gaffed491b0d7e7f3ea3309fad3a88778c"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__deepsleep.html#gaffed491b0d7e7f3ea3309fad3a88778c">watch_enter_shallow_sleep</a> (char *message)</td></tr>
<tr class="memdesc:gaffed491b0d7e7f3ea3309fad3a88778c"><td class="mdescLeft">&#160;</td><td class="mdescRight">Enters a shallow sleep mode by disabling all pins and peripherals except the RTC and (optionally) the LCD. You can wake from this mode by pressing the ALARM button, if you have an registered an external wake callback on the ALARM button. When your app wakes from this shallow sleep mode, your app_setup method will be called, since this function will have disabled things you set up.  <a href="group__deepsleep.html#gaffed491b0d7e7f3ea3309fad3a88778c">More...</a><br /></td></tr>
<tr class="separator:gaffed491b0d7e7f3ea3309fad3a88778c"><td class="memSeparator" colspan="2">&#160;</td></tr>
<tr class="memitem:gad37a6fd46f2d8b72cd371660c2d3af77"><td class="memItemLeft" align="right" valign="top">void&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="group__deepsleep.html#gad37a6fd46f2d8b72cd371660c2d3af77">watch_enter_deep_sleep</a> ()</td></tr>
<tr class="memdesc:gad37a6fd46f2d8b72cd371660c2d3af77"><td class="mdescLeft">&#160;</td><td class="mdescRight">Enters the SAM L22's lowest-power mode, BACKUP.  <a href="group__deepsleep.html#gad37a6fd46f2d8b72cd371660c2d3af77">More...</a><br /></td></tr>
<tr class="separator:gad37a6fd46f2d8b72cd371660c2d3af77"><td class="memSeparator" colspan="2">&#160;</td></tr>
</table>
<a name="details" id="details"></a><h2 class="groupheader">Detailed Description</h2>
<p >This section covers functions related to preparing for and entering BACKUP mode, the deepest sleep mode available on the SAM L22. </p>
<h2 class="groupheader">Function Documentation</h2>
<a id="gaae4dfbad44338b179a7b2d8a286bacbe" name="gaae4dfbad44338b179a7b2d8a286bacbe"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gaae4dfbad44338b179a7b2d8a286bacbe">&#9670;&nbsp;</a></span>watch_disable_extwake_interrupt()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void watch_disable_extwake_interrupt </td>
          <td>(</td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>pin</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Unregisters the RTC interrupt on one of the EXTWAKE pins. This will prevent a value change on one of these pins from waking the device from shallow and deep sleep modes. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">pin</td><td>Either pin BTN_ALARM, A2, or A4. If the pin is BTN_ALARM, this function DOES NOT disable the internal pull down on that pin. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a id="gad37a6fd46f2d8b72cd371660c2d3af77" name="gad37a6fd46f2d8b72cd371660c2d3af77"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gad37a6fd46f2d8b72cd371660c2d3af77">&#9670;&nbsp;</a></span>watch_enter_deep_sleep()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void watch_enter_deep_sleep </td>
          <td>(</td>
          <td class="paramname"></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Enters the SAM L22's lowest-power mode, BACKUP. </p>
<p >This function does some housekeeping before entering BACKUP mode. It first disables all peripherals except for the RTC, and disables the tick interrupt (since that would wake us up from deep sleep). It also sets an external wake source on the ALARM button, if one was not already set. If you wish to wake from another source, such as one of the external wake interrupt pins on the 9-pin connector, set that up prior to calling this function. </p><dl class="section note"><dt>Note</dt><dd>If you have a callback set for an external wake interrupt, it will be called if triggered while in ACTIVE, IDLE or STANDBY modes, but it <em>will not be called</em> when waking from BACKUP. Waking from backup is effectively like waking from reset, except that your <a class="el" href="group__app.html#ga5d2bdd732abd6aff9e4a75e672ba94e4">app_wake_from_deep_sleep</a> function will be called. </dd></dl>
<dl class="section warning"><dt>Warning</dt><dd>On current revisions of the SAM L22 silicon, the ALARM_BTN pin (PA02 RTC/IN2) cannot wake the device from deep sleep mode. There is an errata note (Reference: 15010) that says that due to a silicon bug, RTC/IN2 is not functional in BACKUP. As a result, you should not call this function unless you have a device on the nine-pin connector with an external interrupt on pin A2 or A4 (i.e. an accelerometer with an interrupt pin). </dd></dl>

</div>
</div>
<a id="gaffed491b0d7e7f3ea3309fad3a88778c" name="gaffed491b0d7e7f3ea3309fad3a88778c"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gaffed491b0d7e7f3ea3309fad3a88778c">&#9670;&nbsp;</a></span>watch_enter_shallow_sleep()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void watch_enter_shallow_sleep </td>
          <td>(</td>
          <td class="paramtype">char *&#160;</td>
          <td class="paramname"><em>message</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Enters a shallow sleep mode by disabling all pins and peripherals except the RTC and (optionally) the LCD. You can wake from this mode by pressing the ALARM button, if you have an registered an external wake callback on the ALARM button. When your app wakes from this shallow sleep mode, your app_setup method will be called, since this function will have disabled things you set up. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">message</td><td>Either NULL, or a string representing a message to display while in shallow sleep mode. If this parameter is NULL, the screen will be blanked out, and this function will disable the SLCD peripheral for additional power savings. If the message is non-NULL, it will replace any text on the screen, and will be displayed at position 0 (so you should pad out the beginning of the string with spaces if you wish for the message to appear on line 2, i.e. "    SLEEP"). Also note that this function will NOT clear any indicator segments that you have set. This is by design, in case you wish to leave an indicator lit in sleep mode.</td></tr>
  </table>
  </dd>
</dl>
<p>This shallow sleep mode is not the lowest power mode available (see watch_enter_deep_sleep), but it has the benefit of retaining your application state and being able to wake from the ALARM button. It also provides an option for displaying a message to the user when asleep. Note that whether you want to wake from the ALARM button, the A2 RTC interrupt or the A4 interrupt, you must configure this by calling watch_register_extwake_callback first.</p>
<p >Power consumption in shallow sleep mode varies a bit with the battery voltage and the temperature, but at 3 V and 25~30° C you can roughly estimate:</p><ul>
<li>&lt; 12µA current draw with the LCD controller on (message != NULL)</li>
<li>&lt; 6µA current draw with the LCD controller off (message == NULL) </li>
</ul>

</div>
</div>
<a id="ga2de1f1012475654c4741f60808581196" name="ga2de1f1012475654c4741f60808581196"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga2de1f1012475654c4741f60808581196">&#9670;&nbsp;</a></span>watch_get_backup_data()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">uint32_t watch_get_backup_data </td>
          <td>(</td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>reg</em></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Gets 32 bits of data from the RTC's backup register. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">reg</td><td>A register from 0-7. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section return"><dt>Returns</dt><dd>An unsigned 32 bit integer with the from the backup register. </dd></dl>

</div>
</div>
<a id="gacad726423f5f38697c87474ab25244ca" name="gacad726423f5f38697c87474ab25244ca"></a>
<h2 class="memtitle"><span class="permalink"><a href="#gacad726423f5f38697c87474ab25244ca">&#9670;&nbsp;</a></span>watch_register_extwake_callback()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void watch_register_extwake_callback </td>
          <td>(</td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>pin</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">ext_irq_cb_t&#160;</td>
          <td class="paramname"><em>callback</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool&#160;</td>
          <td class="paramname"><em>level</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Registers a callback on one of the RTC's external wake pins, which can wake the device from deep sleep (aka BACKUP) mode. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">pin</td><td>Either pin BTN_ALARM, A2, or A4. These are the three external wake pins. If the pin is BTN_ALARM, this function also enables an internal pull down on that pin. </td></tr>
    <tr><td class="paramname">callback</td><td>The callback to be called if this pin triggers outside of deep sleep mode. If this is NULL, no callback will be called even in normal mode, but the interrupt will still be enabled so that it can wake from deep sleep or backup mode. </td></tr>
    <tr><td class="paramname">level</td><td>The level you wish to scan for: true for rising, false for falling. Note that you cannot scan for both rising and falling edges like you can with the external interrupt pins; with the external wake interrupt, you can only get one or the other. </td></tr>
  </table>
  </dd>
</dl>
<dl class="section note"><dt>Note</dt><dd>When in normal or STANDBY mode, this will function much like a standard external interrupt situation: these pins will wake from standby, and your callback will be called. However, if the device enters deep sleep and one of these pins wakes the device, your callback WILL NOT be called, as the device is basically waking from reset at that point. </dd></dl>
<dl class="section warning"><dt>Warning</dt><dd>As of the current SAM L22 silicon revision (rev B), the BTN_ALARM pin cannot wake the device from BACKUP mode. You can still use this function to register a BTN_ALARM interrupt in normal or deep sleep mode, but to wake from BACKUP, you will need to use pin A2 or A4. </dd></dl>

</div>
</div>
<a id="ga385b36922ec76c5fe697772f97a05846" name="ga385b36922ec76c5fe697772f97a05846"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ga385b36922ec76c5fe697772f97a05846">&#9670;&nbsp;</a></span>watch_store_backup_data()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void watch_store_backup_data </td>
          <td>(</td>
          <td class="paramtype">uint32_t&#160;</td>
          <td class="paramname"><em>data</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">uint8_t&#160;</td>
          <td class="paramname"><em>reg</em>&#160;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td>
        </tr>
      </table>
</div><div class="memdoc">

<p>Stores data in one of the RTC's backup registers, which retain their data in deep sleep mode. </p>
<dl class="params"><dt>Parameters</dt><dd>
  <table class="params">
    <tr><td class="paramname">data</td><td>An unsigned 32 bit integer with the data you wish to store. </td></tr>
    <tr><td class="paramname">reg</td><td>A register from 0-7. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
</div><!-- contents -->
<!-- start footer part -->
<hr class="footer"/><address class="footer"><small>
Generated by&#160;<a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.9.2
</small></address>
</body>
</html>
